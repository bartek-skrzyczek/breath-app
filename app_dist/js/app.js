"use strict";var app=window.breathwork=window.angular.module("breathwork",["pascalprecht.translate","ui.router","ngAudio","angular-click-outside","ngTouch"]);app.run(function($rootScope,$state,$stateParams){$rootScope.$state=$state,$rootScope.$stateParams=$stateParams,$rootScope.$on("$stateChangeStart",function(event){null===window.localStorage.getItem("breathwork")&&(window.localStorage.setItem("breathwork",!0),event.preventDefault(),$state.go("tutorial.pageView",{tutorialId:"Tutorial_1"}))})}),app.config(function($stateProvider,$urlRouterProvider,$httpProvider,$translateProvider){$translateProvider.useSanitizeValueStrategy(null),$translateProvider.useStaticFilesLoader({prefix:"languages/",suffix:".json"}),$translateProvider.preferredLanguage("pl"),$urlRouterProvider.otherwise("/exercise"),$stateProvider.state("page",{url:"/page",templateUrl:"views/page.html"}).state("page.pageView",{url:"/:pageId",templateUrl:function($stateParams){return"languages/pl/"+$stateParams.pageId+".html"},controller:"page"}).state("tutorial",{url:"/tutorial",templateUrl:"views/tutorial.html"}).state("tutorial.pageView",{url:"/:tutorialId",templateUrl:function($stateParams){return"languages/pl/"+$stateParams.tutorialId+".html"},controller:"tutorial"}).state("exercise",{url:"/exercise",templateUrl:"views/exercise.html",controller:"exercise"})}),function(app,angular){app.controller("menu",function($scope,$timeout){var menuIsActive=!1;$scope.state="",$scope.$on("$stateChangeSuccess",function(event,next){$scope.closeMenu(),$scope.state=next.name}),$scope.$on("setTitle",function(event,title){$scope.title=title}),$scope.showMenu=function(){angular.element(".menu").addClass("active"),$timeout(function(){menuIsActive=!0})},$scope.closeMenu=function(){menuIsActive&&(angular.element(".menu").removeClass("active"),menuIsActive=!1)}})}(window.breathwork,window.angular),function(app){app.controller("exercise",function($scope,$state,$rootScope){$scope.state="config",$scope.eta="",$scope.frequences=[5,6,7],$scope.durations=[5,10,15,30],$scope.activeFreq=6,$scope.activeDuration=10,$scope.etaUpdate=function(eta){$scope.eta!==eta&&($scope.eta=eta)},$scope.setActiveDuration=function(duration){$scope.activeDuration=duration},$scope.setActiveFrequency=function(freq){$scope.activeFreq=freq},$scope.pause=function(){$scope.state="pause",$rootScope.$broadcast("pauseExercise",{})},$scope.stop=function(){$scope.state="config",$rootScope.$broadcast("stopExercise",{})},$scope.play=function(){$scope.state="exercise",$rootScope.$broadcast("resumeExercise",{frequency:$scope.activeFreq,duration:$scope.activeDuration})},$scope.onClickCircle=function(){$rootScope.$broadcast("startExercise",{frequency:$scope.activeFreq,duration:$scope.activeDuration}),$scope.state="exercise"}})}(window.breathwork),function(app){app.controller("page",function(){})}(window.breathwork),function(app){app.controller("tutorial",function($scope,$state){$scope.go=function(name){$state.go("tutorial.pageView",{tutorialId:name})},$scope.goToApp=function(){$state.go("exercise")}})}(window.breathwork),function(app,BezierEasing,moment){app.directive("visualisation",function($rootScope,$timeout,ngAudio){return{transclude:!0,restrict:"E",template:"<canvas></canvas>",scope:{onClickCircle:"=",eta:"&"},link:function(scope,element){function fmod(a,b){return Number((a-Math.floor(a/b)*b).toPrecision(8))}function stop(){state="wait",sound&&sound.stop&&sound.stop(),exerciseDuration=0}function drawCircle(){ctx.beginPath(),ctx.arc(width/2,height/2,radius,0,2.2*Math.PI),ctx.fillStyle="#fff",ctx.shadowColor="rgba(0, 0, 0, 0.25)",ctx.shadowBlur=20,ctx.shadowOffsetX=-1,ctx.shadowOffsetY=5,ctx.fill()}function calculateETA(){var current=(new Date).getTime()-start;return moment.duration(exerciseDurationTarget-exerciseDuration-current,"ms")}function render(){var t=(new Date).getTime();width=canvas.width=element.outerWidth(),height=canvas.height=element.outerHeight(),"undefined"!=typeof strategies[state]&&strategies[state](t),requestAnimationFrame(render)}var activeConfig,width,height,radius,start,sound,config={5:{firstPhaseDuration:6,secondPhaseDuration:4,file:"sounds/5perMinute.mp3"},6:{firstPhaseDuration:6,secondPhaseDuration:4,file:"sounds/6perMinute.mp3"},7:{firstPhaseDuration:6,secondPhaseDuration:4,file:"sounds/7perMinute.mp3"}},easingIn=new BezierEasing(.56,.18,.35,.97),easingOut=new BezierEasing(.39,.03,.75,1),startRadius=70,maxRadius=120,canvas=element.children()[0],ctx=canvas.getContext("2d"),state="wait",exerciseDuration=0,exerciseDurationTarget=0,playImg=new Image;playImg.src="images/play_blue.svg",$rootScope.$on("$stateChangeStart",function(){sound&&sound.stop&&sound.stop()}),scope.$on("startIntro",function(){state="intro"}),scope.$on("pauseExercise",function(){state="pause",sound&&sound.stop&&sound.stop();var current=(new Date).getTime()-start;exerciseDuration+=current}),scope.$on("stopExercise",function(){stop()}),scope.$on("resumeExercise",function(event,data){state="exercise",start=(new Date).getTime(),activeConfig=config[data.frequency],sound=ngAudio.load(activeConfig.file),sound.loop=!0,sound.play()}),scope.$on("startExercise",function(event,data){state="exercise",start=(new Date).getTime(),exerciseDurationTarget=1e3*data.duration*60,activeConfig=config[data.frequency],sound=ngAudio.load(activeConfig.file),sound.loop=!0,sound.play()}),element[0].addEventListener("click",function(event){if("wait"===state){var rect=canvas.getBoundingClientRect(),x=event.clientX-rect.left,y=event.clientY-rect.top;radius*radius>=(x-width/2)*(x-width/2)+(y-height/2)*(y-height/2)&&scope.onClickCircle()}},!1);var strategies={wait:function(){if(radius=startRadius,drawCircle(),playImg.complete){var imgSize=.75*radius;ctx.shadowColor="transparent",ctx.drawImage(playImg,(width-imgSize)/2,(height-1.2*imgSize)/2,imgSize,imgSize),ctx.font=Math.floor(imgSize/3)+"px Roboto bold",ctx.textAlign="center",ctx.textBaseline="top",ctx.fillStyle="#17a6ef",ctx.fillText("Start",width/2,height/2+imgSize/1.7)}},exercise:function(t){var text,currentTime=fmod(t-start,1e3*(activeConfig.firstPhaseDuration+activeConfig.secondPhaseDuration));currentTime<=1e3*activeConfig.firstPhaseDuration?(radius=startRadius+easingIn(currentTime/(1e3*activeConfig.firstPhaseDuration))*(maxRadius-startRadius),text="Wdech"):(currentTime-=1e3*activeConfig.firstPhaseDuration,radius=maxRadius-easingOut(currentTime/(1e3*activeConfig.secondPhaseDuration))*(maxRadius-startRadius),text="Wydech");var eta=calculateETA();eta.asMilliseconds()<0&&stop(),drawCircle(),ctx.font=Math.floor(25)+"px Roboto bold",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillStyle="#17a6ef",ctx.fillText(text,width/2,height/2),scope.eta()(eta.format("mm:ss"))},intro:function(){drawCircle()},pause:function(){drawCircle()}};render()}}})}(window.breathwork,window.BezierEasing,window.moment),function(app,angular){app.directive("iconFill",function(){return{restrict:"A",link:function(scope,element,attr){element.on("load",function(event){var object=angular.element(event.currentTarget.getSVGDocument().children[0]);object.attr("fill",attr.iconFill)})}}})}(window.breathwork,window.angular);